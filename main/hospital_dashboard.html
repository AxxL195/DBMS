<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Hospital Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background-color: #f8f9fa; }
    .sidebar {
      height: 100vh;
      background-color: #dc3545;
      color: white;
      padding-top: 20px;
    }
    .sidebar a {
      color: white;
      display: block;
      padding: 10px 20px;
      text-decoration: none;
    }
    .sidebar a:hover {
      background-color: #c82333;
    }
    .main {
      padding: 20px;
    }
  </style>
</head>
<body>
  <div class="d-flex">
    <!-- Sidebar -->
    <div class="sidebar">
      <h4 class="text-center mb-4">üè• Dashboard</h4>
      <a href="#" id="overviewBtn">Overview</a>
      <a href="#" id="requestsBtn">My Requests</a>
      <a href="#" id="createBtn">Create Request</a>
      <a href="#" id="donorsBtn">Available Donors</a>
      <a href="#" id="profileBtn">Edit Profile</a>
      <hr>
      <a href="#" id="logoutBtn" class="text-warning">Logout</a>
    </div>

    <!-- Main Content -->
    <div class="main flex-grow-1">
      <div id="contentArea"></div>
    </div>
  </div>

  <script>
    const backendURL = "http://localhost:5000/api/hospitals";
    // const hospital = JSON.parse(localStorage.getItem("hospital"));
    // if (!hospital) window.location.href = "hospital_portal.html";
    
    //for preview only
    let hospital = JSON.parse(localStorage.getItem("hospital"));
    // TEMPORARY for preview only:
    if (!hospital) {
        hospital = {
        hospital_id: 1,
        hospital_name: "Test Hospital",
        email: "test@hospital.com",
        city: "Mumbai",
        is_verified: true
      };
    }


    const contentArea = document.getElementById("contentArea");

    // ---- Render Overview ----
    function showOverview() {
      contentArea.innerHTML = `
        <div class="card p-4 shadow">
          <h3 class="text-danger">Welcome, ${hospital.hospital_name}</h3>
          <p><strong>Email:</strong> ${hospital.email}</p>
          <p><strong>City:</strong> ${hospital.city}</p>
          <p><strong>Verification Status:</strong> ${hospital.is_verified ? "‚úÖ Verified" : "‚ùå Pending"}</p>
        </div>
      `;
    }

    // ---- Render My Requests ----
    async function showRequests() {
      const res = await fetch(`${backendURL}/appointments/${hospital.hospital_id}`);
      const data = await res.json();

      let rows = data.map(r => `
        <tr>
          <td>${r.donor_id || "N/A"}</td>
          <td>${r.appointment_date}</td>
          <td>${r.status}</td>
          <td>
            ${r.status !== "Cancelled" ? 
              `<button class="btn btn-sm btn-outline-danger" onclick="cancelRequest(${r.appointment_id})">Cancel</button>` 
              : ""}
          </td>
        </tr>`).join("");

      contentArea.innerHTML = `
        <div class="card p-4 shadow">
          <h3 class="text-danger mb-3">My Blood Requests</h3>
          <table class="table table-bordered">
            <thead><tr><th>Donor ID</th><th>Date</th><th>Status</th><th>Action</th></tr></thead>
            <tbody>${rows}</tbody>
          </table>
        </div>
      `;
    }

    async function cancelRequest(id) {
      await fetch(`${backendURL}/cancel/${id}`, { method: "PUT" });
      alert("Request cancelled successfully!");
      showRequests();
    }

    // ---- Render Create Request ----
    async function showCreateRequest() {
      contentArea.innerHTML = `
        <div class="card p-4 shadow">
          <h3 class="text-danger mb-3">Create Blood Request</h3>
          <form id="requestForm">
            <div class="mb-3">
              <label>Donor ID</label>
              <input type="number" id="donorId" class="form-control" required>
            </div>
            <div class="mb-3">
              <label>Appointment Date</label>
              <input type="date" id="appointmentDate" class="form-control" required>
            </div>
            <div class="mb-3">
              <label>Notes</label>
              <textarea id="notes" class="form-control"></textarea>
            </div>
            <button type="submit" class="btn btn-danger w-100">Create Request</button>
          </form>
        </div>
      `;

      document.getElementById("requestForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const donor_id = document.getElementById("donorId").value;
        const appointment_date = document.getElementById("appointmentDate").value;
        const notes = document.getElementById("notes").value;

        await fetch(`${backendURL}/appointments`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ donor_id, hospital_id: hospital.hospital_id, appointment_date, notes })
        });
        alert("Request created successfully!");
        showRequests();
      });
    }

    // ---- Render Available Donors ----
    async function showDonors() {
      const res = await fetch(`${backendURL}/donors`);
      const donors = await res.json();

      let rows = donors.map(d => `
        <tr>
          <td>${d.first_name} ${d.last_name}</td>
          <td>${d.blood_group}</td>
          <td>${d.city}</td>
          <td>
            <button class="btn btn-sm btn-outline-success" onclick="autoFillDonor(${d.donor_id})">Select</button>
          </td>
        </tr>`).join("");

      contentArea.innerHTML = `
        <div class="card p-4 shadow">
          <h3 class="text-danger mb-3">Available Donors</h3>
          <table class="table table-bordered">
            <thead><tr><th>Name</th><th>Blood Group</th><th>City</th><th>Action</th></tr></thead>
            <tbody>${rows}</tbody>
          </table>
        </div>
      `;
    }

    // Autofill donor ID when selected
    function autoFillDonor(id) {
      showCreateRequest();
      setTimeout(() => {
        document.getElementById("donorId").value = id;
      }, 200);
    }

    // ---- Render Edit Profile ----
    function showProfile() {
      contentArea.innerHTML = `
        <div class="card p-4 shadow">
          <h3 class="text-danger mb-3">Edit Profile</h3>
          <form id="profileForm">
            <input type="text" id="phone" class="form-control mb-2" placeholder="Phone" required>
            <input type="text" id="address" class="form-control mb-2" placeholder="Address" required>
            <input type="text" id="city" class="form-control mb-2" placeholder="City" required>
            <input type="text" id="state" class="form-control mb-2" placeholder="State" required>
            <input type="text" id="zip" class="form-control mb-2" placeholder="Zip Code" required>
            <button type="submit" class="btn btn-danger w-100">Update</button>
          </form>
        </div>
      `;

      document.getElementById("profileForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const phone_number = document.getElementById("phone").value;
        const address = document.getElementById("address").value;
        const city = document.getElementById("city").value;
        const state = document.getElementById("state").value;
        const zip_code = document.getElementById("zip").value;

        await fetch(`${backendURL}/update/${hospital.hospital_id}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ phone_number, address, city, state, zip_code })
        });
        alert("Profile updated!");
      });
    }

    // ---- Logout ----
    document.getElementById("logoutBtn").addEventListener("click", () => {
      localStorage.clear();
      window.location.href = "index.html";
    });

    // ---- Event Listeners ----
    document.getElementById("overviewBtn").addEventListener("click", showOverview);
    document.getElementById("requestsBtn").addEventListener("click", showRequests);
    document.getElementById("createBtn").addEventListener("click", showCreateRequest);
    document.getElementById("donorsBtn").addEventListener("click", showDonors);
    document.getElementById("profileBtn").addEventListener("click", showProfile);

    // Default load
    showOverview();
  </script>
</body>
</html>
